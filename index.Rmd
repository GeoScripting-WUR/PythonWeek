---
author: "Jan Verbesselt, Jorge Mendes de Jesus, Aldo Bergsma, Johannes Eberenz, Dainius Masiliunas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  knitrBootstrap::bootstrap_document:
    title: "Week 3: Python for geo-scripting"
    theme: "simplex"
    highlight: Tomorrow Night Bright
    menu: FALSE
    theme.chooser: TRUE
    highlight.chooser: TRUE
---

# [WUR Geoscripting](https://geoscripting-wur.github.io/) <img src="http://www.wur.nl/upload/b43b7095-e452-482a-8969-fed9a50393a8_WUR_RGB_standard.png" alt="WUR logo" style="height: 35px;"/>

# "Week 3: Python for geo-scripting"

Good morning! Today we will start working with Python and do a refresher of functions in Python. First complete the Intro to Python course in Datacamp and then go through today's tutorial.

### Today's schedule

- Follow DataCamp Intro to Python course
- Learn how to work with virtual environments: Conda
- Learn how to create Jupyter Notebook
- Refresher for python

Using Python within Linux:

- Wide user community and support
- Free
- Flexiblility
- Open-source

How?! via:

- GDAL/OGR
- GEOS
- Rasterio
- Shapely
- Mapplotlib
- Folium
- Fiona
- GeoPandas
- ArcPy (requires ArcMap license)

Have a look at this question on GIS StackExchange:

- [Alternatives to using arcpy](https://gis.stackexchange.com/questions/34509/alternatives-to-using-arcpy)
- [Clipping raster with vector layer using gdal](https://gis.stackexchange.com/questions/16657/clipping-raster-with-vector-layer-using-gdal)

## Python editors and IDEs
* Most modern text editors do nice python highlighting, e.g. Sublime Text can be set up nicely for Python
* Jupyter notebook or Ipython Notebook are good choices for short scripts. Jupyter Notebook is a continuation of Ipython Notebook. The name “Jupyter” was inspired by the leading open languages for science (that is, Julia, Python, and R) [blog about history of Jupyter Notebook](https://www.datacamp.com/community/blog/ipython-jupyter). The notebooks allows you to have your source code, results and comments in one document ! See here for a simple Jupyter [notebook example](http://nbviewer.ipython.org/github/GeoScripting-WUR/PythonWeek/blob/gh-pages/A%20simple%20notebook.ipynb). [More info](http://jupyter.org/).
* There are a number of proper Integrated Development Environments [IDE] for Python. An IDE is a software application that provides facilities for software development. Personally I have good experience with [PyCharm](https://www.jetbrains.com/pycharm/). For running on a server, [rodeo](https://github.com/yhat/rodeo/) gives a similar interface as RStudio server.
* Spyder is nice a lightweight IDE and can be installed from the terminal (`sudo apt-get install spyder`)

## Python package management
For Python, a set of tools co-exist for installing and managing packages. From most to least desirable, you should try to install packages by:

* Using the distribution's package manager (on Ubuntu, that's `sudo apt-get install python-*`). This is the easiest and guaranteed to work right, although the package version might be older than you expect.
* Using [conda](https://conda.io/docs/user-guide/tasks/manage-pkgs.html) to install packages and to keep separate sets of packages. With Python, often the dependencies and versions can differ from project to project. If you want to specifally use a combination of packages with certain versions and keep that package set saved in an environment, then conda has conda environments to save this set of packages. A conda environment is similar to a virtual environment, but different from a virtual machine. Conda is available for Windows, macOS and Linux.
* Using `pip` to manage packages and `virtualenv` to manage your environment. *pip* is a python package installer, that is pretty much standard nowadays. It is recommended to run it in a virtualenv to prevent conflicts, however, virtualenvs can be problematic when it comes to package dependencies. `virtualenv` can be used to keep separate sets of packages in its own directory tree. A demonstration of `pip` and `virtualenv` can be found here [here](http://www.dabapps.com/blog/introduction-to-pip-and-virtualenv-python/)


### Conda or MiniConda
Using Anaconda is very useful in projects since most of the times package version and dependencies are an issue. Anaconda, when installed comes already with a lot of packages such as *numpy* and *gdal*. Instead of the large version of Anaconda you can use the base version called MiniConda. MiniConda has the same features, but only installs the base package and requires manual installation for extra packages.

The basic usage of Conda or MiniConda, after installed, is as follows:
```{r, eval=FALSE, engine='bash'}
conda install numpy
```
To install packages. Beware that you will still have to include this packages in the created environments.
```{r, eval=FALSE, engine='bash'}
conda create --name astrolab python=2.7 numpy
```
To create a new environment called `astrolab` with Python 2.7 and including *numpy*.
```{r, eval=FALSE, engine='bash'}
conda info --envs
```
To list the available environments. Conda puts an asterisk (*) in front of the active environment.
```{r, eval=FALSE, engine='bash'}
% Linux, macOS
source activate astrolab
% Windows
activate astrolab
```
To activate an environment. After this, the current environment is shown in (parentheses) or [brackets] in front of your prompt (`(astrolab)$`).
```{r, eval=FALSE, engine='bash'}
% Linux, macOS
source deactivate
% Windows
deactivate
```
To deactivate the environmnet and go back to root.
```{r, eval=FALSE, engine='bash'}
conda remove --name astrolab --all
```
To remove the environment `astrolab`.

You should beware that the activated environment is only valid for the shell in which you activated. For instance, if you close the shell window and open a new one you will have to activate it again. Additionaly, if you use `sudo` commands in a conda environment, it will return it to the root python and not the active environment.

Some helpful utilities are:

* `conda list` to check which packages are installed in `root` or in the active environment;
* `which python` or `python --version` to check which python verison is used in the environment.
* `conda install --name astrolab matplotlib` to install extra modules in your (running) conda environment

## Getting started with Python within a Linux OS

- Launch a Linux virtual machine and login.

- Open the Terminal and type the following to check the installed GDAL version:

```{r, eval = TRUE, engine='bash'}
## from R: system("gdal-config --version")
## From the terminal:
python2 --version
python3 --version
gdal-config --version
```

- Type the following to start Python 2.7:

```{r, eval=FALSE, engine='bash'}
python2 # type this in the terminal to start the python interpreter
```

An example script to find out what the installed Python version is ([more info in question asked on stackoverflow](https://stackoverflow.com/questions/1093322/how-do-i-check-what-version-of-python-is-running-my-script))

```{r, engine='python'}
import sys
print sys.version #parentheses necessary in python 3. 
```

To exit Python in the terminal:
```{r, eval=FALSE, engine='python'}
exit()
or 
quit()
```

## Running Python in Jupyter Notebooks

You can program Python in your terminal, but more facilities are available to make coding and documenting in Python easier through notebooks or Python IDEs. Today we will have a go with Jupyter Notebooks. In other lessons you can use the Python IDE Spyder. For now try the following commands in your terminal:

```{r, eval=FALSE, engine='bash'}
# Set directory at home
cd

# Create conda environment
conda create -n astrolab python=2.7 numpy ipython-notebook # astrolab is name of your conda environment

# Activate conda environment
source activate astrolab
```

By creating your conda environment, you created a set of packages and a Python version to be used only in that specific conda environment. In your terminal you can see the name of your conda environment at the start of the command line before your user information. Now that we are working in our conda environment with all the necessary packages with correct versions, we can start with setting up our notebook.

```{r, eval=FALSE, engine='bash'}
# Start a Jupyter Notebook from terminal
jupyter notebook
```

If everything goes according to plan, Jupyter will pop up in your browser. You will see a menu with all files. Browse to your workspace, where you want to store your Python script. In the right top click on new folder (if you dont have folder/project structure yet) and/or click on python2 to create a Jupyter Notebook. Click on help and have a go at the `User Interface Tour`. Give your notebook a name.

These are the basic functions you will need today:
- `Save and checkpoint`
- `Insert cell below`
- `Run`
- `Code/Markdown/Heading`

Similar to RMarkdown, Jupyter Notebooks has code cells (called code) and text cells (called markdowns). Insert some extra cells and change the first cell from code to markdown. Enter some docmentation for your code (e.g. your teamname, exercise and date). Leave the other cells on code. 

## A short Python refresher

### Finding help
Now we can try some coding. First we learn how to look for help while coding in Python. In the second cell type the code below and run it (ctrl + enter is shortcut for run).


```{r, engine='python', eval=FALSE}
import sys
help(sys)
print "-------------------------------------"
help(1)
```

See how the functions in the `sys` module got listed and how we got information how to work with integers. Sometimes you also need to use the internet to find information.

> **Question** 1: What does this mean `__ __` around words: e.g: `__doc__`?

Try out the following!!!

```{r, engine='python'}
help('hamster')
```


See also: 

* [http://www.rafekettler.com/magicmethods.html](http://www.rafekettler.com/magicmethods.html)
* [https://stackoverflow.com/questions/1090620/special-magic-methods-in-python](https://stackoverflow.com/questions/1090620/special-magic-methods-in-python)

### Finding information via Pydoc

Go to: [https://docs.python.org/2/library/pydoc.html](https://docs.python.org/2/library/pydoc.html) or run the script below in your terminal to create a HTTP server with information from pydoc.

```{r, engine='bash', eval=FALSE}
pydoc -p 1234
echo "pydoc server ready at http://localhost:1234/"
```

Then go to `http://localhost:1234/` via your preferred browser. You can see a list of built-in modules and available modules.

### Numbers and variables

We continue working in Python. 

> **Question 2**: What is the difference between 10 and 10.0 when dealing with data types in Python?

```{r, engine='python'}
print(int(10.6))
```

Variable is a storage location or symbolic name to a value e.g.:

```{r, engine='python'}
building = 'Gaia'
buildingNumber = 101
'Gaia'
"doesn't"
'Gaia' + ' is in Wageningen'
```

There is no need to say or define the datatype, `python` has a loose type variable declaration. 

*If it walks like a duck, swims like a duck and quacks like a duck I call it a duck*

Python is basically a list of objects:
List are organised with indexes. E.g. 

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(engine = 'python')
```

### Lists
Now we will have a go with lists.

Tip!: Variables, functions and methods that you define in one of your Jupyter Notebook cells can be used in other cells too.

Run this code in one cell:
```{r campus, engine='python'}
campus = ['Gaia', 'Lumen', 'Radix', 'Forum']
# how to can we print Forum?
print(campus[3])
# how to access the end of the list (while having no idea how big it is)
print(campus[-1])
# how to access the first 3 items
print(campus[0:3])
```

Run this code in another cell. We will do some appending, inserting, extending and steps:
```{r, engine='python', eval = FALSE}
campus.append("Atlas")
campus.insert(1,"SoilMuseum")
campus.extend(["Action", "Vitae", "Zodiac"])
print campus
print campus[::2]
## list[start:end:step]
```

See how the notebook remembered how you set the variable `campus`. 

> **Question 3:** What are the major differences between Append/Extend?

> **Question 4:** What building is `campus[-2]`?

### Dictionaries, loops, if/else

Let there be dictionaries... A dictionary is an unordered set of key:value pairs. Like in the dictionary, 'food':'voedsel'.

```{r, engine='python'}
# dictionary
campusDic = {101:'Gaia',
             100:'Lumen',
             107:'Radix',
             102:'Forum',
             104:'Altas'}
print campusDic[102]
```

Loops: watch out here with code indentation. Python uses indentation to define code blocks and not `{}` like other languages.
`print building` has to be *indented* by 1 tab or 4 spaces ( [recommended](https://stackoverflow.com/questions/119562/tabs-versus-spaces-in-python-programming) ).

```{r, engine='python'}
campus = ['Gaia','Lumen', 'Radix', 'Forum']
for building in campus:
    print building
```


Here, `building` is a variable that will contain any item in the campus list.

Generic loops in Python have to interact over a sequence of objects e.g.

```{r, engine='python'}
range(5)
for number in range(5):
    print number
```

Object interaction and functional programming is an important part of Python programming and its tools are extensive.
`if`/`else`:

```{r, engine='python'}
x = 3
if x < 3:
    print "below 3"
else:
    print "above 3"
```

```{r, engine='python'}
x = 3
if x == 1:
    print "it is one"
elif x==2:
    print "it is two"
elif x==3:
    print "it is three"
else: 
    print "above 3"
```

### Functions

A function is a section of code that does something specific that you want to use multiple times without having to type the full function again but just call the function by its name.

```{r, engine='python'}
def printPotato():
    print "potato"

printPotato()
```

Functions accept arguments and return variables e.g.:

```{r, engine='python'}
def printHelloName(name):
    print "Good morning " + name

printHelloName("Jan")
```

`return` is used to indicate what you want to obtain from the function, you can `return` multiple items and return can be used to assign output to variables outside of the function.

```{r, engine='python'}
def times3(number):
    tmp = number*3
    return tmp, number
    
print times3(4)

output, input = times3(4)
print(output)
print(input)
```

### Importing modules

Try this!

```{r, engine='python', eval=FALSE}
import this
```

This poem is called the Zen of Python and describes how Python should be used. It is an inside joke, but has some good practices to it. There are more best practice guides for Python [best of best practices guide in Python](https://gist.github.com/sloria/7001839).

```{r, engine='python', eval=FALSE}
from __future__ import braces
```

Another inside joke ... where your Python says that it will never delimit coding blocks by braces instead of indentation. Let's continue with more serious programming.

```{r, engine='python'}
import math
print dir(math) #show names in math module
```

- The best way to learn a module is by checking [documentation](https://docs.python.org/2/).
- Modules are Python's butter and bread. 
- A module contains code that can be used or excuted.

Basically there are three ways to load a module:
```{r, engine='python'}
import math
print math.pi

from math import pi
print pi

import numpy as np
print np.pi
```

> **Question 5**: Which is the best way to import modules?

### Some important internal modules:

- `os`: Access to operating system features
- `os.path`: Manipulating of file names
- `sys`: System specific configuration
- `glob`: Filename pattern matching
- `math`: Mathametical functions
- `datetime`: Date/Time manipulation

> **Question 6**: What is the difference between `os` and `os.path`?

Some examples:

```{r, eval=FALSE, engine='python'}
import glob
glob.glob("*")
```

```{r,engine='python'}
from datetime import timedelta, date
delta = timedelta(days=7)
print date.today()
print date.today()+delta
```

### File access

File access is very simple for 99% of the cases.

Write something to file:

```{r, engine='python'}
fileObj = open('test.txt','w')
fileObj.write('some simple text')
fileObj.close()
```

And read something from a file:

```{r, engine='python'}
fileObj = open('test.txt','r')
a = fileObj.read()
print a
fileObj.close()
```

> **Question 7**: What does `w` and `r` mean?

### Error handling

Sometime problems occur... Errors detected during execution are called *exceptions*.

Good code deals with exceptions:

```{r, error=TRUE, engine='python'}
open("/foo0")
```

The file doesn't exist, so the script stops and outputs an ugly message.

How to deal with this I/O error? Good programming!

```{r, engine='python'}

try:
    open("foo")
except IOError:
    print "no file"

## we can be more precise:
try:
    open("/foo")
except IOError:
    print "no file"
```

### Visualization

Jupyter Notebooks can display output of your code, such as graphs, images and maps in the notebook. A lot of cool visualizations including code in Python are available from the [Python Graph Gallery](https://python-graph-gallery.com/). Before we can do the visualizations, we want to add some Python modules via the terminal.

```{r, engine='bash', eval=FALSE}
## Add Matplotlib and seaborn modules
conda install --name astrolab matplotlib seaborn
# as conda install --name env_name pythonmodule pythonmodule
```

We will make a graph with the `Seaborn` module and plot it with `Matplotlib`. Give it a try!

```{r, engine='python', eval=FALSE}
# Load library
import matplotlib.pyplot as plt
import seaborn as sns

# Load dataset
df = sns.load_dataset('iris')
 
# Create plot
sns.pairplot(df, kind = "reg", hue = "species")
plt.show()
```

Nice visualization huh! Good job.

Now make a map with `Folium`. 
```{r, engine='python', eval=FALSE}
import folium

SF_COORDINATES = (51.9871868, 5.6593948)

map = folium.Map(location=SF_COORDINATES, tiles='Mapbox Control Room', zoom_start=5)
display(map)
```

### Exiting the Jupyter Notebook
Your Jupyter Notebook is automatically saved as a .ipynb (ipython notebook extension) on your computer, but you can also download it as a python script, pdf or html.

By pressing ctrl + c in the terminal where the notebook is running, you cancel the running process. The terminal goes back to command line and you can exit the virtual environment by typing source deactivate.

```{r, engine='bash', eval=FALSE}
source deactivate
```

### Python statements

- `if`
- `for`
- `while`
- `try`
- `type` shows type (e.g. int, float, str) of object
- `class` which executes a block of code and attaches its local names to a `class`, for use in object oriented programming
- `def` which defines a function or statement
- `with` which encloses a code block within a context manager
- `pass` statement, which serves as a `NOP` (no operation)
- `assert`, used during debugging to check for conditions that ought to apply
- `yield`
- `import`

## Python from R

By the way, as you may have noticed, this document is created from an RMarkdown source, which can also include Python code blocks (have a look at the [source](https://github.com/GeoScripting-WUR/PythonWeek/blob/gh-pages/index.Rmd) on github). Similarly Jupyter Notebooks can also use R and other languages!


# Assignment
The assignment for today is to finish the datacamp course: Intro to Python for Data Science. If you finished early and still want to write more scripts, then you can follow one of the fun tutorials below.

# More info
- A great book: [Python Geospatial Development](http://www.amazon.com/Python-Geospatial-Development-Second-Edition/dp/178216152X)
- [The official python tutorial](https://docs.python.org/2/tutorial/)
- [Python Tutorial](http://www.tutorialspoint.com/python/)
- [Best of the best practices in Python - Style guide ](https://gist.github.com/sloria/7001839)
- [Stack OverFlow Python](https://stackoverflow.com/questions/tagged/python)
- [GIS Stack Exchange](https://gis.stackexchange.com/)
- [QGIS can be scripted in python](http://www.qgistutorials.com/en/docs/getting_started_with_pyqgis.html)
- [A simple Iphython Notebook](http://nbviewer.ipython.org/github/GeoScripting-WUR/PythonWeek/blob/gh-pages/A%20simple%20notebook.ipynb)
- [Buffer Example](http://nbviewer.ipython.org/github/GeoScripting-WUR/PythonWeek/blob/gh-pages/Buffer%20example.ipynb)
- [Spatial visualization with Matplotlib](https://github.com/GeoScripting-WUR/PythonWeek/blob/gh-pages/Matplotlib_basemap.ipynb)
- [Spatial visualization with Cartopy](https://github.com/GeoScripting-WUR/PythonWeek/blob/gh-pages/Plot%20Map.ipynb)
- [Reading and formatting geometries with OGR](https://github.com/GeoScripting-WUR/PythonWeek/blob/gh-pages/OGR%20examples.ipynb)


